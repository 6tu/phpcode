<?php/* --------------------------------------------------------------------------pici-server of the artproject picidae http://www.picidae.netCopyright (c) 2007  picidae.net by christoph wachter and mathias judThis program is free software; you can redistribute it and/ormodify it under the terms of the GNU General Public Licenseas published by the Free Software Foundation; either version 2of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful,but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See theGNU General Public License for more details.You should have received a copy of the GNU General Public Licensealong with this program; if not, write to the Free SoftwareFoundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA. -------------------------------------------------------------------------- */// --------------------------------------------------------------------------//  url 相关的变量和数组 参数// --------------------------------------------------------------------------$url_download = array (								// prfix								"^ftp://",								"^sftp://",																// suffix								"\.zip$",								"\.zip[?#]",								"\.tar$",								"\.tar[?#]",								"\.sit$",								"\.sit[?#]",								"\.dmg$",								"\.dmg[?#]",								"\.gz$",								"\.gz[?#]",								"\.tgz$",								"\.tgz[?#]",								"\.exe$",								"\.exe[?#]",								"\.mov$",								"\.mov[?#]",								"\.mpeg$",								"\.mpeg[?#]",								"\.mpg$",								"\.mpg[?#]",								"\.wmv$",								"\.wmv[?#]",								"\.mp3$",								"\.mp3[?#]",								"\.ram$",								"\.ram[?#]",								"\.rm$",								"\.rm[?#]",								"\.pdf$",								"\.pdf[?#]",								"\.rtf$",								"\.rtf[?#]",								"\.doc$",								"\.doc[?#]",								"\.xls$",								"\.xls[?#]",								"\.ppt$",								"\.ppt[?#]",								"\.vcf$",								"\.vcf[?#]"								);								$url_email = array (								"^mailto:"								);								$url_allowed = array (								"^http://",								"^https://"								);								$url_forbidden = array (								// praefix								"^file://",								"^#",								"^javascript",								"^onclick",																// in the content								"127.0.0.1",								"localhost",								"pici.picidae.net",								"picidae.local",								"194.50.176.206"								);// ------------------------------------------------------------$url_protect4python = array (								" "=>"%20",								"\\0" => "",								";"=>"\;",								"&" => "\&",								"\%" => "%",								"%25" => "%",								"%3A" => ":",								"%2F" => "/",								"'" => "\'"								);$url_unprotect = array (								"%25" => "%",								"%3A" => ":",								"%2F" => "/",								"%3F" => "?",								"%3D" => "=",								"%26" => "&"								);/*$url_char_protect = array (								"&" => "\&" //"&" => "%26"								);*/// ------------------------------------------------------------$url_form_same = array (								"^$",								"^\?",								"^#"								);						// --------------------------------------------------------------------------//  url  处理// --------------------------------------------------------------------------function eregiArray ($Array, $string){	// loop through the array	for ($i=0; $i<count($Array); $i++)	{		if (eregi($Array[$i],$string)) return true;	}	return false;}// --------------------------------------------------------------------------// functions// --------------------------------------------------------------------------/*function url_optimize ($url){	global 	$url_download;		global 	$url_email;		global 	$url_allowed;		global 	$url_forbidden;		global 	$url_protect4python;		global 	$url_unprotect;			$url = trim($url);		//protect problematic ascii-chars	$url = strtr($url, $url_char_protect);		return $url;}*/// --------------------------------------------------------------------------function url_protect4python ($url){	global 	$url_download;		global 	$url_email;		global 	$url_allowed;		global 	$url_forbidden;		global 	$url_protect4python;		global 	$url_unprotect;			$url = trim ($url);	$url = addslashes($url);	$url = strtr($url, $url_protect4python);			return $url;}// --------------------------------------------------------------------------// check the url for legitimityfunction url_analyze ($url){	global 	$url_download;		global 	$url_email;		global 	$url_allowed;		global 	$url_forbidden;		global 	$url_protect4python;		global 	$url_unprotect;			// return-values:	// 0 = url is not allowed, unable to handle	// 1 = url is ok -> make picture	// 2 = url is email	// 3 = url is downloadable file		// allowed?	if (eregiArray($url_forbidden,$url)) return 0;	// email	if (eregiArray($url_email,$url)) return 2; 	// downloadable files	elseif (eregiArray($url_download,$url)) return 3;	// allowed url	elseif (eregiArray($url_allowed,$url)) return 1;		else return 0;}// --------------------------------------------------------------------------// check wether url is an allowed link at allfunction url_allowed ($url){	global 	$url_download;		global 	$url_email;		global 	$url_allowed;		global 	$url_forbidden;		global 	$url_protect4python;		global 	$url_unprotect;			if (eregiArray($url_forbidden,$url)) return false;	else return true;}// --------------------------------------------------------------------------// function action2url ($url, $action){	global 	$url_download;		global 	$url_email;		global 	$url_allowed;		global 	$url_forbidden;		global 	$url_protect4python;		global 	$url_unprotect;			// is the action absolute?	if (eregiArray($url_allowed,$action))	{		;	}	// does the action start at root	elseif (eregi("^/",$action))	{		// add the site-domain-path		$action  = eregi_replace ('([a-zA-Z]+://[^/?#]+).*','\\1',$url) .$action;	}	// no url at all	elseif (eregiArray($url_form_same,$action))	{		$action = $url;	}	// otherwise relative url	else	{		// add the path to the current web-directory		$action  = eregi_replace ('([^?#]+/).*','\\1',$url) .$action;	}			// remove trailing search-strings & anchors	$action = eregi_replace ('([^?#]*).*','\\1',$action);			// check wether its now a valid url or not	if (!eregiArray($url_forbidden,$action) && eregiArray($url_allowed,$action))	{		return $action;	}	else return false;	}// --------------------------------------------------------------------------// function relative2absoluteURL ($pageurl, $url){	global 	$url_download;		global 	$url_email;		global 	$url_allowed;		global 	$url_forbidden;		global 	$url_protect4python;		global 	$url_unprotect;			// is the url already absolute?	if (eregi("^.{2,6}://", $url)) ;	elseif (eregi("^javascript:", $url)) ;	// does the url start at root	elseif (eregi("^/",$url))	{		// add the site-domain-path		$url  = eregi_replace ('([a-zA-Z]+://[^/?#]+).*','\\1',$pageurl) .$url;	}	// no url at all	elseif ($url == '' || eregiArray(array('^$','^ '),$url))	{		$url = $pageurl;	}	// a querystring	elseif (eregiArray(array('^\?','^#'),$url))	{		$url = eregi_replace ('([^?#]+).*','\\1',$pageurl) .$url;	}	// otherwise relative url	else	{		// add the path to the current web-directory		$url  = eregi_replace ('([^?#]+/).*','\\1',$pageurl) .$url;	}		return $url;}// --------------------------------------------------------------------------// 加密 url// --------------------------------------------------------------------------function make_ref($url, $nr)		{	$temp = $nr .microtime() .$url;	$ref = md5($temp);	return $ref;}function url2ref($url, $nr, $DB_table)		{	global $DB_link;		// create a reference for the 	$ref = make_ref($url, $nr);		// make a new entry into the Database	$addStmt = "Insert into $DB_table(ref, url, ip, created) values('%s','%s','%s','%f');"; 		if (!mysql_query(sprintf($addStmt, $ref, $url, $_SERVER['REMOTE_ADDR'], ((float) get_mysql_timestamp (0))), $DB_link)) 	{		return false;	}	else	{		return $ref;	}}// --------------------------------------------------------------------------function form2db($url, $nr, $key, $DB_table){	global $DB_link;		// create a reference for the 	$ref = make_ref($url, $nr);		// make a new entry into the Database	$addStmt = "Insert into $DB_table(url, cipher_key, ref, ip, created) values('%s','%s','%s','%s','%f');"; 		if (!mysql_query(sprintf($addStmt, $url, $key, $ref, $_SERVER['REMOTE_ADDR'], ((float) get_mysql_timestamp (0))), $DB_link)) 	{		return false;	}	else	{		return $ref;	}}function form2db_update($ref, $formfields, $hiddenfields, $DB_table)		{	global $DB_link;		// make a new entry into the Database	$addStmt1 = "UPDATE $DB_table SET formfields = '%s' WHERE ref = '%s';"; 	$addStmt2 = "UPDATE $DB_table SET hiddenfields = '%s' WHERE ref = '%s';"; 		if (!mysql_query(sprintf($addStmt1,$formfields,$ref), $DB_link)) 	{		return false;	}	else	{		if (!mysql_query(sprintf($addStmt2,$hiddenfields,$ref), $DB_link)) 		{			return false;		}		else		{			return true;		}	}}// --------------------------------------------------------------------------// 解密 url // --------------------------------------------------------------------------function ref2url($ref, $DB_link, $DB_table)		{	global $timelimit_links;		// check whether the data exists	$qryStmt = "SELECT * from $DB_table where ref = '$ref';";		if ($exists_query=mysql_query(sprintf($qryStmt), $DB_link)) 	{		//wieviele resultate		$numrows = mysql_num_rows($exists_query);	}					// Daten in Array packen und zurckgeben	if ($numrows > 0)	{		$result_array["idx"] = DemaskString(mysql_result($exists_query, 0, "idx"));		$result_array["url"] = DemaskString(mysql_result($exists_query, 0, "url"));		$result_array["idx_url"] = DemaskString(mysql_result($exists_query, 0, "idx_url"));						return $result_array;	} 	else 	{		// false zurckgeben		return false;	}}// --------------------------------------------------------------------------function formref2url($ref, $DB_link, $DB_table)		{	global $timelimit_links;		// check whether the data exists	//nach daten durchsuchen	//$timeout = timestamp - $timelimit_links * 1000;	//$qryStmt = "SELECT * from $DB_table where ref = '$ref' and created > '$timeout';"; 	$qryStmt = "SELECT * from $DB_table where ref = '$ref';";		if ($exists_query=mysql_query(sprintf($qryStmt), $DB_link)) 	{		//wieviele resultate		$numrows = mysql_num_rows($exists_query);	}					// Daten in Array packen und zurckgeben	if ($numrows > 0)	{		$key = DemaskString(mysql_result($exists_query, 0, "cipher_key"));		$url = DemaskString(mysql_result($exists_query, 0, "url"));		$url .= "?";				// variables		$formfields = DemaskString(mysql_result($exists_query, 0, "formfields"));		if ($formfields && $formfields != "")		{			$formfields_array = explode ("#",$formfields);			$first = true;						foreach ($formfields_array as $v)			{				if ($v && $v != "")				{					if (!$first) $url .= "&";					else $first = false;										$url .= "$v=";										if (isset($_REQUEST[$v]))					{						if (isset($_REQUEST["c"]) && $_REQUEST["c"] == 1) 						{							$tmp = pici_decrypt ($key, $_REQUEST[$v]);														if (!eregi('%',$tmp)) $url .= urlencode($tmp);							else $url .= $tmp;													}						else 						{							$url .= urlencode($_REQUEST[$v]);						}					}				}			}		}				// hidden variables		$url .= DemaskString(mysql_result($exists_query, 0, "hiddenfields"));				$url_array["url"] = $url;		$url_array["key"] = $key;				return $url_array;	} 	else 	{		// false zurckgeben		return false;	}}// ----------------------------------------------------------//  设置时区// ----------------------------------------------------------if(function_exists('date_default_timezone_set'))	date_default_timezone_set(date_default_timezone_get());	// ----------------------------------------------------------// 加密和解密// ----------------------------------------------------------function pici_decrypt ($key, $str){	global $debug;		$str1 = base64_decode($str);	if ($str1 =='') 	{		$str2 = '';	}	elseif (function_exists ('mdecrypt_generic')) 	{		$td = mcrypt_module_open('des', '', 'ecb', '');		$iv_size = mcrypt_enc_get_iv_size($td);		$iv = mcrypt_create_iv($iv_size, MCRYPT_RAND);		mcrypt_generic_init($td, $key, $iv);		$str2 = trim(mdecrypt_generic($td, $str1));		mcrypt_generic_deinit($td);		if ($debug) echo  ("decrypted with mcrypt: $str2 <br/>\n"); 			}	else	{		$str2 = des ($key,$str1,0,0,null);				if ($debug) echo  ("decrypted with des.php: $str2 <br/>\n"); 	}		return $str2;}// calculates the current mysql timestamp// the difference of the timestamp can be set in seconds// 3600 means 1 hour (3600 seconds) in the past.function get_mysql_timestamp ($diff){	// YYYYmmddhhmmss	$timestamp = date ("YmdHis") - $diff;		return $timestamp;}function get_timestamp_seconds ($diff){	// returns a float in seconds	$timestamp = microtime (true) - $diff;		return $timestamp;}function get_key ($bytes){	//$key = "8bytekey";	//$key = "this is a 24 byte key !!";		$key = substr (md5(time()), $bytes *-1);		return $key;}// ----------------------------------------------------------// Input: parse and protect// Output: parse and deprotect ;-)// ----------------------------------------------------------//parser funktionenfunction Veraendern($string){	//html-tags entfernen	$string1=strip_tags($string);		//html-sonderzeichen einfgen	$string2=htmlentities($string1);		//<br> tags einfgen	$string3=nl2br($string2);	//steuerungszeichen entfernen	$trans = array("\n" => "", "\r" => "", "\t" => "", "\v" => "", "\0" => "", "[" => "(", "]" => ")");	$string4 = strtr($string3, $trans);		return $string4;}function Schuetzen($string){	//eingabe maskieren	$string1=addslashes($string);		return $string1;}function DemaskString($string){	return stripslashes($string);}function MaskString_and($string){	// fr das XML muss das "&" durch "&amp;" ersetzt werden	$trans = array("&" => "&amp;");	$string = strtr($string, $trans);	return $string;}// ----------------------------------------------------------// Display Errormessages// ----------------------------------------------------------//display error messagesfunction DisplayErrMsg($message){	printf("%s\n", $message);	}?>